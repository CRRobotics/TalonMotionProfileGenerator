<html>
<head>
<title>Path Generator</title>
<script src="math.js"></script>
</head>
<body>
<canvas id="myCanvas" width="800px" height="800px" style="width:400px;height=400px"></canvas>

<script>
var c = document.getElementById("myCanvas");
var context = c.getContext("2d");

//	Works for 5th degree polynomials
//	Takes in 2 pts, 2 velocity vectors, 2 acceleration vectors
function getPolynomialConstants(pt1, pt2, v1, v2, a1, a2)
{
	var matrixA = math.matrix([[Math.pow(pt1['x'], 5), Math.pow(pt1['x'], 4), Math.pow(pt1['x'], 3), Math.pow(pt1['x'], 2), Math.pow(pt1['x'], 1), 1],
					[Math.pow(pt2['x'], 5), Math.pow(pt2['x'], 4), Math.pow(pt2['x'], 3), Math.pow(pt2['x'], 2), Math.pow(pt2['x'], 1), 1],
					[5 * Math.pow(pt1['x'], 4), 4 * Math.pow(pt1['x'], 3), 3 * Math.pow(pt1['x'], 2), 2 * Math.pow(pt1['x'], 1), 1, 0],
					[5 * Math.pow(pt2['x'], 4), 4 * Math.pow(pt2['x'], 3), 3 * Math.pow(pt2['x'], 2), 2 * Math.pow(pt2['x'], 1), 1, 0],
					[20 * Math.pow(pt1['x'], 3), 12 * Math.pow(pt1['x'], 2), 6 * Math.pow(pt1['x'], 1), 2, 0, 0],
					[20 * Math.pow(pt2['x'], 3), 12 * Math.pow(pt2['x'], 2), 6 * Math.pow(pt2['x'], 1), 2, 0, 0]]);
	vDir1 = (v1['x'] == 0) ? 0 : v1['y'] / v1['x'];
	vDir2 = (v2['x'] == 0) ? 0 : v2['y'] / v2['x'];
	var matrixB = math.matrix([pt1['y'], pt2['y'], vDir1, vDir2, a1['y'], a2['y']]);
	var coefficients = math.multiply(math.inv(matrixA), matrixB);
	return coefficients._data;
}

function getPolynomialConstantsFromPtsOnly(points)
{
	var matrixArrA = [];
	
	for (i = 0; i < 6; i++)
	{
		var tempArr = [];
		for (j = 5; j >= 0; j--)
			tempArr.push(Math.pow(points[i][0], j));
		matrixArrA.push(tempArr);
	}
	
	var matrixA = math.matrix(matrixArrA);
	var matrixB = math.matrix([points[0][1], points[1][1], points[2][1], points[3][1], points[4][1], points[5][1]]);
	var coefficients = math.multiply(math.inv(matrixA), matrixB);
	return coefficients;
}

//Gets the y-value of a 5th degree polynomial defined by coefficients at x
function f(x, coefficients)
{
	var sum = 0;
	for (i = 5; i >= 0; i--)
	{
		sum += Math.pow(x, i) * coefficients[5 - i];
	} 
	return sum;
}

//Gets dy/dx of a 5th degree polynomial defined by coefficients at x
function derivative(x, coefficients)
{
	var sum = 0;
	for (i = 4; i >= 0; i--)
	{
		sum += (i + 1) * Math.pow(x, i) * coefficients[4 - i];
	} 
	return sum;
}

//Gets d2y/dx2 of a 5th degree polynomial defined by coefficients at x
function acceleration(x, coefficients)
{
	var sum = 0;
	for (i = 3; i >= 0; i--)
	{
		sum += (i + 2) * (i + 1) * Math.pow(x, i) * coefficients[3 - i];
	} 
	return sum;
}

//spacing is half the robot width
function splitPath(cPath, spacing, lowerLimit, upperLimit, iVel, fVel)
{
	var increment = (upperLimit - lowerLimit) / 3;
	var lowerPathPoints = new Array();
	var upperPathPoints = new Array();
	for (ii = 0; ii < 4; ii++)
	{
		var xOrig = lowerLimit + ii * increment;
		var yOrig = f(lowerLimit + ii * increment, cPath);
		var m = derivative(xOrig, cPath);
		if (Math.abs(m) < 0.00001)
		{
			upperPathPoints[ii] = [xOrig, yOrig + spacing];
			lowerPathPoints[ii] = [xOrig, yOrig - spacing];
			console.log("(" + xOrig + ", " + yOrig + ")");
			//alert("Upper Paths: (" + upperPathPoints[upperPathPoints.length - 1][0] + ", " + upperPathPoints[upperPathPoints.length - 1][1] + ")\nLower Paths: (" + lowerPathPoints[lowerPathPoints.length - 1][0] + ", " + lowerPathPoints[lowerPathPoints.length - 1][1] + ")");
		}
		else
		{
			var perpendicular = -1 / m;
			var dx = Math.sqrt((spacing * spacing) / (1 + perpendicular * perpendicular));
			var dy = dx * perpendicular;
			lowerPathPoints[ii] = [xOrig + dx, yOrig + dy];
			upperPathPoints[ii] = [xOrig - dx, yOrig - dy];
		}
	}
	upperPathPoints.push([lowerLimit, iVel]);
	upperPathPoints.push([upperLimit, fVel]);
	lowerPathPoints.push([lowerLimit, iVel]);
	lowerPathPoints.push([upperLimit, fVel]);
	return [getPolynomialConstantsFromPtsAndVel(upperPathPoints)._data, getPolynomialConstantsFromPtsAndVel(lowerPathPoints)._data];
}

function drawPolynomial(constants, upperLimit, ctx)
{
	ctx.beginPath();
	var scale = 700 / upperLimit;
	var increment = upperLimit / 80;
	ctx.moveTo(0, f(0, constants));
	for (k = 1; k < 80; k++)
	{
		ctx.lineTo(k * increment * scale, f(k * increment, constants) * scale);
		//console.log("(" + k * increment + ", " + f(k * increment, constants) + ")\n");
	}
	ctx.stroke();
}

var p1 = {x: 3, y: 2};
var vel1 = {x: 0, y: 0};
var acc1 = {x: 0, y: -0.5};

var p2 = {x: 5, y: 6};
var vel2 = {x: 0, y: 0};
var acc2 = {x: 0, y: 0.5};
var robotMaxSpeed = 2;//5 inches per second
var robotAcc = 0.5;//1 inch per second per second

var centerPathConstants = getPolynomialConstants(p1, p2, vel1, vel2, acc1, acc2);
drawPolynomial(centerPathConstants, p2['y'] + 1, context);

</script>
</body>
</html>